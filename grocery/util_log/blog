Fri Sep 19 15:13:13 CST 2014
.s/g[0-9]*/&,/g

Today I used the command above to add comma for every sever_id in a line, wonderful!

事故回顾：
2014年12月25日，圣诞节。临近中午的时候，为了更好地刺激玩家消费，运营同事决定临时增开三组累积充值的奖励。但因为累积消费的原配置是在当天的0点就开始生效。因此之前的玩家的充值积分不会被算到新配置的积分里去，需要人工添加积分。运营同学找到了我。我问了下宋铭代码是谁写的，他说这个很老了，都记不清了。虽然我对这个功能的代码从来没有看过，但想到岳朗24日开会时讲到的主动推动事情的精神，我决定去做这件事，后来事实证明这是草率鲁莽，而非勇敢。当我去找到小贝和清泉问怎么加积分的时候，他们展开了一个小的讨论。其中有一个观点是只要给25日0点到上午充值超过2000元的人加，因为只有这些人充值积分可能超过5000(新增配置奖励的最低档位)。如果当时我能更专注些的话，弄懂运营的需求的话，我就会坚决支持这种方案，这种方案即使出错的话，影响范围也会小很多；可是当时我没有。最后他们讨论的结果是给所有的玩家增加积分，让他们后三个配置项的积分变到当前充值金额。我让清泉找一个咱们内部人员有参加充值活动的号。清泉把范晓的号给了我。我把范晓的充值积分直接改到20000分。然后去他的机器上看, 结果发现积分显示都已经达到，但是无法领奖。然后我又跑到自己的机器上看代码，发现有一个叫is_complete的变量，在修改玩家累积充值记录的代码里关于is_complete的注释有两条: is_complete=1的话是-充值成功，而is_complete=0的话是-充值不满足，需要记录。我没有去通读上下文的代码去看相关的依赖关系，而是凭借脑子里下意识的判断认为范晓的账号是虚拟充值，所以导致充值不满足。接着我把范晓账号里的数据is_complete改成1, 然后他就能够领奖了。错误的测试之后，我依法炮制，将当天所有充值的玩家积分改成当前充值金额，is_complete改成1。而实际上，按原代码的逻辑，只有在充值金额总数大于配置金额的情况下，is_complete才会被改为True. 所以，当天0点到下午1点20的充值玩家，都变得有资格去领取新增的三个累积充值配置奖励了。待到我吃饭回来，宋铭告诉我出事了。我用脚本清完积分后发现，包括GS在内，混服有249个玩家领取了额外的三个配置项奖励，苹果有51个玩家领取了额外的三个配置项奖励，两边总共只有6个玩家是正常领取的。之后这批非正常领取的玩家被封了号，累积充值活动按钮关闭，刘江，昊洋和其它的运营策划同学手动处理了v8以上的玩家数据，岳朗、吴伟和宋铭把v7及以下用户的数据回了档。

事故影响:
整个项目组下午到晚上的人力资源都耗费在处理这件事故上。
25日玩家充值人数较平常减少40%-50%， 充值金额减少数万元


后续措施：

1. 彻底改变工作态度，知之为知之，不知为不知；不知道的地方努力去弄明白，而不是一知半解进行问题操作，害人害己。
2. 在涉及线上数据的变更时，先考虑最坏的情况是什么，然后做好相应的代码兼容确保最坏的情况不会发生，然后再去考虑功能/需求的正常实现。
3. 遇到相关模块数据变更时，一定找到该功能的撰写者让其给出最安全的方法，如果功能撰写者很忙，那么一定要把自己写的东西给他review一下；如果这也不能实现，则一定要找一个经验丰富的老程序员review代码。 
